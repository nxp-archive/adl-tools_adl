#
# Basic cache test.
#

CORE n=:P

= asm

 lwz    r2,0x1000(0)
 add    r3,r2,r1
 subic. r5,r5,2
 stw    r3,0(r4)
 stw    r3,4(r4)     # Should hit in the cache due to last access.
 stw    r3,0(r6)     # Note:  Should wrap around on 32-bit boundary.
 mfspr  r20,52       # This will clear the cache enable bits.
 rlwinm r20,r20,0,2,31
 mtspr  52,r20
 stw    r3,0x100(r4) # This will now propagate out to memory.

= /asm

= mdopts

 instr-offset: 0x100

= /mdopts

# <GEN>
MD n=Mem ra=0x00000100 d=0x80401000	# lwz r2,0x1000(0)
MD n=Mem ra=0x00000104 d=0x7C620A14	# add r3,r2,r1
MD n=Mem ra=0x00000108 d=0x34A5FFFE	# subic. r5,r5,2
MD n=Mem ra=0x0000010c d=0x90640000	# stw r3,0(r4)
MD n=Mem ra=0x00000110 d=0x90640004	# stw r3,4(r4) # Should hit in the cache due to last access.
MD n=Mem ra=0x00000114 d=0x90660000	# stw r3,0(r6) # Note: Should wrap around on 32-bit boundary.
MD n=Mem ra=0x00000118 d=0x7E940AA6	# mfspr r20,52 # This will clear the cache enable bits.
MD n=Mem ra=0x0000011c d=0x569400BE	# rlwinm r20,r20,0,2,31
MD n=Mem ra=0x00000120 d=0x7E940BA6	# mtspr 52,r20
MD n=Mem ra=0x00000124 d=0x90640100	# stw r3,0x100(r4) # This will now propagate out to memory.
# </GEN>

RD n=CCR d=0xc0000000
RD n=NIA d=0x0100
RD n=GPR i=1 d=0x1fff
RD n=GPR i=4 d=0x2000
RD n=GPR i=6 d=0xfffffffe

MD n=Mem ra=0x1000 d=0xdeadbeef
MD n=Mem ra=0x2000 d=0x00000000
MD n=Mem ra=0x2100 d=0x00000000
MD n=Mem ra=0xfffffffc d=0
MD n=Mem ra=0x00000000 d=0

TRACE

I id=1 ea=0x100
C a=miss n=L1i t=ifetch set=2 way=0 lm=0x7f ra=0x100
C a=miss n=L2 t=ifetch set=2 way=0 lm=0x7f ra=0x100
C n=L2 a=load t=ifetch set=2 way=0 lm=0x7f ra=0x100
C n=L1i a=load t=ifetch set=2 way=0 lm=0x7f ra=0x100
M n=Mem t=ifetch ea=0x100 ra=0x100 d=0x80401000
INSTR op=0x80401000 asm="#1 lwz 2,0,4096"
C a=miss n=L1d t=read set=32 way=0 lm=0x7f ra=0x1000
C a=miss n=L2 t=read set=32 way=0 lm=0x7f ra=0x1000
R n=CCR d=0xc0111000
C n=L2 a=load t=read set=32 way=0 lm=0x7f ra=0x1000
C n=L1d a=load t=read set=32 way=0 lm=0x7f ra=0x1000
M n=Mem ea=0x1000 ra=0x1000 t=read d=0xdeadbeef
R n=GPR i=2 d=0xdeadbeef

I id=2 ea=0x104
C a=hit n=L1i t=ifetch set=2 way=0 lm=0x7f ra=0x100
M n=Mem t=ifetch ea=0x104 ra=0x104 d=0x7c620a14
INSTR op=0x7c620a14 asm="#2 add 3,2,1"
R n=GPR i=3 d=0xdeaddeee

I id=3 ea=0x108
C a=hit n=L1i t=ifetch set=2 way=0 lm=0x7f ra=0x100
M n=Mem t=ifetch ea=0x108 ra=0x108 d=0x34a5fffe
INSTR op=0x34a5fffe asm="#3 addic. 5,5,65534"
R n=GPR i=5 d=0xfffffffe
R n=CR d=0x80000000

I id=4 ea=0x10c
C a=hit n=L1i t=ifetch set=2 way=0 lm=0x7f ra=0x100
M n=Mem t=ifetch ea=0x10c ra=0x10c d=0x90640000
INSTR op=0x90640000 asm="#4 stw 3,4,0"
C a=miss n=L1d t=write set=0 way=0 lm=0x7f ra=0x2000
C a=miss n=L2 t=write set=64 way=0 lm=0x7f ra=0x2000
R n=CCR d=0xc0212000
C n=L2 a=load t=write set=64 way=0 lm=0x7f ra=0x2000
C n=L1d a=load t=write set=0 way=0 lm=0x7f ra=0x2000
M n=Mem ea=0x2000 ra=0x2000 t=write d=0xdeaddeee

I id=5 ea=0x110
C a=hit n=L1i t=ifetch set=2 way=0 lm=0x7f ra=0x100
M n=Mem t=ifetch ea=0x110 ra=0x110 d=0x90640004
INSTR op=0x90640004 asm="#5 stw 3,4,4"
C a=hit n=L1d t=write set=0 way=0 lm=0x7f ra=0x2000
R n=CCR d=0xc1212000
M n=Mem ea=0x2004 ra=0x2004 t=write d=0xdeaddeee

I id=6 ea=0x114
C a=hit n=L1i t=ifetch set=2 way=0 lm=0x7f ra=0x100
M n=Mem t=ifetch ea=0x114 ra=0x114 d=0x90660000
INSTR op=0x90660000 asm="#6 stw 3,6,0"
C a=miss n=L1d t=write set=63 way=0 lm=0x7f ra=0xffffff80
C a=miss n=L2 t=write set=127 way=0 lm=0x7f ra=0xffffff80
C n=L2 a=load t=write set=127 way=0 lm=0x7f ra=0xffffff80
C n=L1d a=load t=write set=63 way=0 lm=0x7f ra=0xffffff80
M n=Mem ea=0xfffffffc ra=0xfffffffc t=write d=0x0000dead
C a=miss n=L1d t=write set=0 way=1 lm=0x7f ra=0x0
C a=miss n=L2 t=write set=0 way=0 lm=0x7f ra=0x0
R n=CCR d=0xc1414000
C n=L2 a=load t=write set=0 way=0 lm=0x7f ra=0x0
C n=L1d a=load t=write set=0 way=1 lm=0x7f ra=0x0
M n=Mem ea=0x0 ra=0x0 t=write d=0xdeee0000

I id=7 ea=0x118
C a=hit n=L1i t=ifetch set=2 way=0 lm=0x7f ra=0x100
M n=Mem t=ifetch ea=0x118 ra=0x118 d=0x7e940aa6
INSTR op=0x7e940aa6 asm="#7 mfspr 20,52"
R n=GPR i=20 d=0xc1414000

I id=8 ea=0x11c
C a=hit n=L1i t=ifetch set=2 way=0 lm=0x7f ra=0x100
M n=Mem t=ifetch ea=0x11c ra=0x11c d=0x569400be
INSTR op=0x569400be asm="#8 rlwinm 20,20,0,2,31"
R n=GPR i=20 d=0x01414000

I id=9 ea=0x120
C a=hit n=L1i t=ifetch set=2 way=0 lm=0x7f ra=0x100
M n=Mem t=ifetch ea=0x120 ra=0x120 d=0x7e940ba6
INSTR op=0x7e940ba6 asm="#9 mtspr 20,52"
R n=CCR d=0x01414000

I id=10 ea=0x124
M n=Mem t=ifetch ea=0x124 ra=0x124 d=0x90640100
INSTR op=0x90640100 asm="#10 stw 3,4,256"
M n=Mem ea=0x2100 t=write d=0xdeaddeee ra=0x2100

I id=11 ea=0x128
M n=Mem t=ifetch ea=0x128 ra=0x128 d=0x0
INSTR op=0x0 asm="#11 halt"

RESULTS

RD n=GPR i=2 d=0xdeadbeef
RD n=GPR i=3 d=0xdeaddeee
RD n=GPR i=5 d=0xfffffffe

# Basically, nothing should reach memory:  All stored data should still be in the cache.

CD n=L1i set=2 way=0 ra=0x0000000000000100 valid=1 dirty=0 locked=0 d=0x80401000,0x7c620a14,0x34a5fffe,0x90640000,0x90640004,0x90660000,0x7e940aa6,0x569400be,0x7e940ba6,0x90640100,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000
CD n=L1d set=0 way=0 ra=0x0000000000002000 valid=1 dirty=1 locked=0 d=0xdeaddeee,0xdeaddeee,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000
CD n=L1d set=0 way=1 ra=0x0000000000000000 valid=1 dirty=1 locked=0 d=0xdeee0000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000
CD n=L1d set=32 way=0 ra=0x0000000000001000 valid=1 dirty=0 locked=0 d=0xdeadbeef,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000
CD n=L1d set=63 way=0 ra=0x00000000ffffff80 valid=1 dirty=1 locked=0 d=0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x0000dead
CD n=L2 set=0 way=0 ra=0x0000000000000000 valid=1 dirty=0 locked=0 d=0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000
CD n=L2 set=2 way=0 ra=0x0000000000000100 valid=1 dirty=0 locked=0 d=0x80401000,0x7c620a14,0x34a5fffe,0x90640000,0x90640004,0x90660000,0x7e940aa6,0x569400be,0x7e940ba6,0x90640100,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000
CD n=L2 set=32 way=0 ra=0x0000000000001000 valid=1 dirty=0 locked=0 d=0xdeadbeef,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000
CD n=L2 set=64 way=0 ra=0x0000000000002000 valid=1 dirty=0 locked=0 d=0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000
CD n=L2 set=127 way=0 ra=0x00000000ffffff80 valid=1 dirty=0 locked=0 d=0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000

MD n=Mem ra=0x1000 d=0xdeadbeef
MD n=Mem ra=0x2000 d=0x00000000
MD n=Mem ra=0x2100 d=0xdeaddeee
MD n=Mem ra=0xfffffffc d=0
MD n=Mem ra=0x00000000 d=0

