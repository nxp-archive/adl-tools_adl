#
# Test that we can throw an exception within an exception.
# In this case, we generate a debug exception on a program exception.
#
= asm

  addi r1,r1,1
  .long 0xdeadbeef
  mtspr 65,r10
  addi r1,r1,1
  addi r1,r1,1
  .long 0xdeadbeef
  addi r1,r1,1
  .long 0xdeadbeef
  addi r1,r1,1
  .long 0xdeadbeef
  addi r1,r1,1  
  .long 0x0
  mfspr r20,SRR0  # Program exception handler.
  addi r20,r20,4
  mtspr SRR0,r20
  addi r30,r30,1
  rfi
  .long 0x0
  addi r31,r31,1  # Debug exception handler.
  rfci    

= /asm

= aopts
 -mregnames -mbooke
= /aopts

= mdopts
instr-offset: 0x1000
= /mdopts

TEST id=0

#
# <GEN>
MD n=Mem ra=0x00001000 d=0x38210001	#	addi r1,r1,1
MD n=Mem ra=0x00001004 d=0xDEADBEEF	#	.long 0xdeadbeef
MD n=Mem ra=0x00001008 d=0x7D4113A6	#	mtspr 65,r10
MD n=Mem ra=0x0000100c d=0x38210001	#	addi r1,r1,1
MD n=Mem ra=0x00001010 d=0x38210001	#	addi r1,r1,1
MD n=Mem ra=0x00001014 d=0xDEADBEEF	#	.long 0xdeadbeef
MD n=Mem ra=0x00001018 d=0x38210001	#	addi r1,r1,1
MD n=Mem ra=0x0000101c d=0xDEADBEEF	#	.long 0xdeadbeef
MD n=Mem ra=0x00001020 d=0x38210001	#	addi r1,r1,1
MD n=Mem ra=0x00001024 d=0xDEADBEEF	#	.long 0xdeadbeef
MD n=Mem ra=0x00001028 d=0x38210001	#	addi r1,r1,1  
MD n=Mem ra=0x0000102c d=0x00000000	#	.long 0x0
MD n=Mem ra=0x00001030 d=0x7E9A02A6	#	mfspr r20,SRR0  # Program exception handler.
MD n=Mem ra=0x00001034 d=0x3A940004	#	addi r20,r20,4
MD n=Mem ra=0x00001038 d=0x7E9A03A6	#	mtspr SRR0,r20
MD n=Mem ra=0x0000103c d=0x3BDE0001	#	addi r30,r30,1
MD n=Mem ra=0x00001040 d=0x4C000064	#	rfi
MD n=Mem ra=0x00001044 d=0x00000000	#	.long 0x0
MD n=Mem ra=0x00001048 d=0x3BFF0001	#	addi r31,r31,1  # Debug exception handler.
MD n=Mem ra=0x0000104c d=0x4C000066	#	rfci    
# </GEN>

CORE n=:P
RD n=GPR i=10 d=0x40000000
RD n=IVOR6    d=0x30
RD n=IVOR15   d=0x48

# ea=0x0000 ra=0x1000
TD n=TlbCam set=0 way=0 V=1 TID=0 SIZE=1 TS=0 RPN=0x4 WIMG=0x1 SX=1 SR=1 SW=1 EPN=0

# ea=0x1000 ra=0xA1000
TD n=TlbCam set=0 way=1 V=1 TID=0 SIZE=1 TS=0 RPN=0x284 WIMG=0x2 SX=1 SR=1 SW=1 EPN=0x4

RD n=NIA d=0x00000000

RESULTS

RD n=GPR i=30 d=4
RD n=GPR i=31 d=3
