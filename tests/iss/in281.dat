#
# This tests that we can wake up a core via an event-bus signal, in a
# multi-threaded simulation environment.
#
= asm

	# Set up some data first.
	li r1,10
	li r2,30
	stw r1,0x1004(r0)
	stw r2,0x1008(r0)
	# Wait until the other core has started.
L1:
	lwz r1,0x1000(r0)
	cmpwi r1,1
	bne L1	
	# Then wake up the other core.
	li r1,1
	mtspr 100,r1
	.long 0x0
	.long 0x0
	# The second core signals that it has started, then goes to sleep.
	li r1,1
	stw r1,0x1000(r0)
	.long 0x0
	# We wake up, do some work, then quit.
	lwz r4,0x1004(r0)
	add r4,r4,r4
	stw r4,0x1014(r0)
	lwz r5,0x1008(r0)
	mulli r5,r5,3
	stw r5,0x1018(r0)
	.long 0x0

= /asm

#
# <GEN>
MD n=Mem ra=0x00000000 d=0x3820000A	#	li r1,10
MD n=Mem ra=0x00000004 d=0x3840001E	#	li r2,30
MD n=Mem ra=0x00000008 d=0x90201004	#	stw r1,0x1004(r0)
MD n=Mem ra=0x0000000c d=0x90401008	#	stw r2,0x1008(r0)
MD n=Mem ra=0x00000010 d=0x80201000	#	lwz r1,0x1000(r0)
MD n=Mem ra=0x00000014 d=0x2C010001	#	cmpwi r1,1
MD n=Mem ra=0x00000018 d=0x4082FFF8	#	bne L1	
MD n=Mem ra=0x0000001c d=0x38200001	#	li r1,1
MD n=Mem ra=0x00000020 d=0x7C241BA6	#	mtspr 100,r1
MD n=Mem ra=0x00000024 d=0x00000000	#	.long 0x0
MD n=Mem ra=0x00000028 d=0x00000000	#	.long 0x0
MD n=Mem ra=0x0000002c d=0x38200001	#	li r1,1
MD n=Mem ra=0x00000030 d=0x90201000	#	stw r1,0x1000(r0)
MD n=Mem ra=0x00000034 d=0x00000000	#	.long 0x0
MD n=Mem ra=0x00000038 d=0x80801004	#	lwz r4,0x1004(r0)
MD n=Mem ra=0x0000003c d=0x7C842214	#	add r4,r4,r4
MD n=Mem ra=0x00000040 d=0x90801014	#	stw r4,0x1014(r0)
MD n=Mem ra=0x00000044 d=0x80A01008	#	lwz r5,0x1008(r0)
MD n=Mem ra=0x00000048 d=0x1CA50003	#	mulli r5,r5,3
MD n=Mem ra=0x0000004c d=0x90A01018	#	stw r5,0x1018(r0)
MD n=Mem ra=0x00000050 d=0x00000000	#	.long 0x0
# </GEN>

CORE n=:procs:P0

RD n=NIA d=0x0

CORE n=:procs:P1

# This is set so that core 1 will immediately halt, but when awoken will execute
# its code.
RD n=NIA d=0x2c

MD n=Mem ra=0x1004 d=0x0
MD n=Mem ra=0x1008 d=0x0
MD n=Mem ra=0x1014 d=0x0
MD n=Mem ra=0x1018 d=0x0

RESULTS

MD n=Mem ra=0x1004 d=10
MD n=Mem ra=0x1008 d=30
MD n=Mem ra=0x1014 d=20
MD n=Mem ra=0x1018 d=90
