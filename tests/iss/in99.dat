#
# Tests cache locking instructions.
#

CORE n=:P

= asm

	dcbtls 0,r10,r0          # Locks 0x2000
	addi   r10,r10,0x2000
	dcbtls 0,r10,r0          # Locks 0x4000
	addi   r10,r10,0x2000
	dcbtls 0,r10,r0          # Locks 0x6000
	addi   r10,r10,0x2000
	dcbtls 0,r10,r0          # Locks 0x8000
	addi   r10,r10,0x2000
	stw    r1,0(r10)         # Store should go to L2 b/c of fully locked set.
	lwz    r2,4(r10)         # Load should go to L2 b/c of fully locked set.
	dcbst  r10,r0
= /asm

= aopts

 -mregnames -me500

= /aopts

= mdopts

 instr-offset: 0x100

= /mdopts

# <GEN>
MD n=Mem ra=0x00000100 d=0x7C0A014C	#	dcbtls 0,r10,r0          # Locks 0x2000
MD n=Mem ra=0x00000104 d=0x394A2000	#	addi   r10,r10,0x2000
MD n=Mem ra=0x00000108 d=0x7C0A014C	#	dcbtls 0,r10,r0          # Locks 0x4000
MD n=Mem ra=0x0000010c d=0x394A2000	#	addi   r10,r10,0x2000
MD n=Mem ra=0x00000110 d=0x7C0A014C	#	dcbtls 0,r10,r0          # Locks 0x6000
MD n=Mem ra=0x00000114 d=0x394A2000	#	addi   r10,r10,0x2000
MD n=Mem ra=0x00000118 d=0x7C0A014C	#	dcbtls 0,r10,r0          # Locks 0x8000
MD n=Mem ra=0x0000011c d=0x394A2000	#	addi   r10,r10,0x2000
MD n=Mem ra=0x00000120 d=0x902A0000	#	stw    r1,0(r10)         # Store should go to L2 b/c of fully locked set.
MD n=Mem ra=0x00000124 d=0x804A0004	#	lwz    r2,4(r10)         # Load should go to L2 b/c of fully locked set.
MD n=Mem ra=0x00000128 d=0x7C0A006C	#	dcbst  r10,r0
# </GEN>

RD n=NIA d=0x0100
RD n=CCR d=0xc0000000

RD n=GPR i=1  d=0xdeadbeef
RD n=GPR i=10 d=0x2000

MD n=Mem ra=0x2004 d=0x1
MD n=Mem ra=0x4004 d=0x2
MD n=Mem ra=0x6004 d=0x3
MD n=Mem ra=0x8004 d=0x4
MD n=Mem ra=0xa000 d=0x12345678
MD n=Mem ra=0xa004 d=0x87654321

RESULTS

RD n=GPR i=1 d=0xdeadbeef
RD n=GPR i=2 d=0x87654321

# The L1 cache should just have the touch data, since it becomes fully locked.
CD n=L1d set=0 way=0 ra=0x0000000000002000 valid=1 dirty=0 locked=1 d=0x00000000,0x00000001,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000
CD n=L1d set=0 way=1 ra=0x0000000000004000 valid=1 dirty=0 locked=1 d=0x00000000,0x00000002,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000
CD n=L1d set=0 way=2 ra=0x0000000000006000 valid=1 dirty=0 locked=1 d=0x00000000,0x00000003,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000
CD n=L1d set=0 way=3 ra=0x0000000000008000 valid=1 dirty=0 locked=1 d=0x00000000,0x00000004,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000

# The L2 cache should have the data from the load and store, since the L1 is
# skipped due to being fully locked.
CD n=L2 set=64 way=2 ra=0x000000000000a000 valid=1 dirty=0 locked=0 d=0xdeadbeef,0x87654321,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000

# Memory is updated due to the flush.
MD n=Mem ra=0x2004 d=0x1
MD n=Mem ra=0x4004 d=0x2
MD n=Mem ra=0x6004 d=0x3
MD n=Mem ra=0x8004 d=0x4
MD n=Mem ra=0xa000 d=0xdeadbeef
MD n=Mem ra=0xa004 d=0x87654321

