#
# Tests the use of a final-hit function to check permissions after a complete
# search of a memory protection unit
#
= asm

	lwz r1,0x2000(r0)
	lwz r2,0x2004(r0)
	lwz r3,0x2008(r0)
	lwz r4,0x200c(r0)
	lwz r5,0x3000(r0) # Will miss
	lwz r6,0x4000(r0) # Hit, but not valid.
	stw r1,0x2010(r0)
	stw r2,0x2014(r0)
	stw r3,0x2018(r0)
	stw r4,0x201c(r0)
	stw r5,0x3000(r0) # Will miss
	stw r6,0x4000(r0) # Hit, but not valid.
	.long 0x0
	# prot fault handler.
	addi r10,r10,1
	mfspr r31,SRR0
	addi  r31,r31,4
	mtspr SRR0,r31
	rfi
	# dtlb handler.
	.long 0x0
	addi r11,r11,1
	mfspr r31,SRR0
	addi  r31,r31,4
	mtspr SRR0,r31
	rfi
	.long 0x0	
	
= /asm

# <GEN>
MD n=Mem ra=0x00000000 d=0x80202000	#	lwz r1,0x2000(r0)
MD n=Mem ra=0x00000004 d=0x80402004	#	lwz r2,0x2004(r0)
MD n=Mem ra=0x00000008 d=0x80602008	#	lwz r3,0x2008(r0)
MD n=Mem ra=0x0000000c d=0x8080200C	#	lwz r4,0x200c(r0)
MD n=Mem ra=0x00000010 d=0x80A03000	#	lwz r5,0x3000(r0) # Will miss
MD n=Mem ra=0x00000014 d=0x80C04000	#	lwz r6,0x4000(r0) # Hit, but not valid.
MD n=Mem ra=0x00000018 d=0x90202010	#	stw r1,0x2010(r0)
MD n=Mem ra=0x0000001c d=0x90402014	#	stw r2,0x2014(r0)
MD n=Mem ra=0x00000020 d=0x90602018	#	stw r3,0x2018(r0)
MD n=Mem ra=0x00000024 d=0x9080201C	#	stw r4,0x201c(r0)
MD n=Mem ra=0x00000028 d=0x90A03000	#	stw r5,0x3000(r0) # Will miss
MD n=Mem ra=0x0000002c d=0x90C04000	#	stw r6,0x4000(r0) # Hit, but not valid.
MD n=Mem ra=0x00000030 d=0x00000000	#	.long 0x0
MD n=Mem ra=0x00000034 d=0x394A0001	#	addi r10,r10,1
MD n=Mem ra=0x00000038 d=0x7FFA02A6	#	mfspr r31,SRR0
MD n=Mem ra=0x0000003c d=0x3BFF0004	#	addi  r31,r31,4
MD n=Mem ra=0x00000040 d=0x7FFA03A6	#	mtspr SRR0,r31
MD n=Mem ra=0x00000044 d=0x4C000064	#	rfi
MD n=Mem ra=0x00000048 d=0x00000000	#	.long 0x0
MD n=Mem ra=0x0000004c d=0x396B0001	#	addi r11,r11,1
MD n=Mem ra=0x00000050 d=0x7FFA02A6	#	mfspr r31,SRR0
MD n=Mem ra=0x00000054 d=0x3BFF0004	#	addi  r31,r31,4
MD n=Mem ra=0x00000058 d=0x7FFA03A6	#	mtspr SRR0,r31
MD n=Mem ra=0x0000005c d=0x4C000064	#	rfi
MD n=Mem ra=0x00000060 d=0x00000000	#	.long 0x0	
# </GEN>

CORE n=:P

RD n=IVOR7  d=0x34
RD n=IVOR13 d=0x4c

TD n=MpuCam set=0 way=1  LB=0x1000 UB=0x1fff SR=1 SW=1 UR=1 UW=1 V=1
TD n=MpuCam set=0 way=2  LB=0x2000 UB=0x2fff SR=0 SW=0 UR=0 UW=0 V=1
TD n=MpuCam set=0 way=5  LB=0x2000 UB=0x2fff SR=1 SW=0 UR=0 UW=0 V=1
TD n=MpuCam set=0 way=10 LB=0x2000 UB=0x2fff SR=0 SW=1 UR=0 UW=0 V=1
TD n=MpuCam set=0 way=11 LB=0x4000 UB=0x4fff SR=0 SW=0 UR=0 UW=0 V=1

MD n=Mem ra=0x2000 d=20
MD n=Mem ra=0x2004 d=30
MD n=Mem ra=0x2008 d=40
MD n=Mem ra=0x200c d=50
MD n=Mem ra=0x2010 d=0
MD n=Mem ra=0x2014 d=0
MD n=Mem ra=0x2018 d=0
MD n=Mem ra=0x201c d=0
MD n=Mem ra=0x3000 d=0
MD n=Mem ra=0x4000 d=0

RESULTS

RD n=GPR i=1  d=20
RD n=GPR i=2  d=30
RD n=GPR i=3  d=40
RD n=GPR i=4  d=50
RD n=GPR i=5  d=0
RD n=GPR i=6  d=0
RD n=GPR i=10 d=2
RD n=GPR i=11 d=2

MD n=Mem ra=0x2000 d=20
MD n=Mem ra=0x2004 d=30
MD n=Mem ra=0x2008 d=40
MD n=Mem ra=0x200c d=50
MD n=Mem ra=0x2010 d=20
MD n=Mem ra=0x2014 d=30
MD n=Mem ra=0x2018 d=40
MD n=Mem ra=0x201c d=50
MD n=Mem ra=0x3000 d=0
MD n=Mem ra=0x4000 d=0
