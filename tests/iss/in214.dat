#
# Checks the behavior of a simplified memory protection unit.
#
= asm

	lwz r1,0x1000(r0)   # Hit, way 1
	addi r1,r1,5
	stw r1,0x1004(r0)   # Hit, way 1
	stw r1,0x1008(r0)   # Hit, way 1
	lwz r2,0x3000(r0)   # Miss
	stw r2,0x2004(r0)   # Hit, permission failure.
	lwz r2,0x2008(r0)   # Hit, permission failure.
	.long 0x0	
	# prot fault handler.
	addi r10,r10,1
	mfspr r31,SRR0
	addi  r31,r31,4
	mtspr SRR0,r31
	rfi
	# dtlb handler.
	.long 0x0
	addi r11,r11,1
	mfspr r31,SRR0
	addi  r31,r31,4
	mtspr SRR0,r31
	rfi
	.long 0x0
	
= /asm

CORE n=:P

# Just for testing- this shouldn't cause a problem, even though it's a
# breakpoint at unmapped memory.
BP ea=0x4000

RD n=IVOR7  d=0x20
RD n=IVOR13 d=0x38

# <GEN>
MD n=Mem ra=0x00000000 d=0x80201000	#	lwz r1,0x1000(r0)   # Hit, way 1
MD n=Mem ra=0x00000004 d=0x38210005	#	addi r1,r1,5
MD n=Mem ra=0x00000008 d=0x90201004	#	stw r1,0x1004(r0)   # Hit, way 1
MD n=Mem ra=0x0000000c d=0x90201008	#	stw r1,0x1008(r0)   # Hit, way 1
MD n=Mem ra=0x00000010 d=0x80403000	#	lwz r2,0x3000(r0)   # Miss
MD n=Mem ra=0x00000014 d=0x90402004	#	stw r2,0x2004(r0)   # Hit, permission failure.
MD n=Mem ra=0x00000018 d=0x80402008	#	lwz r2,0x2008(r0)   # Hit, permission failure.
MD n=Mem ra=0x0000001c d=0x00000000	#	.long 0x0	
MD n=Mem ra=0x00000020 d=0x394A0001	#	addi r10,r10,1
MD n=Mem ra=0x00000024 d=0x7FFA02A6	#	mfspr r31,SRR0
MD n=Mem ra=0x00000028 d=0x3BFF0004	#	addi  r31,r31,4
MD n=Mem ra=0x0000002c d=0x7FFA03A6	#	mtspr SRR0,r31
MD n=Mem ra=0x00000030 d=0x4C000064	#	rfi
MD n=Mem ra=0x00000034 d=0x00000000	#	.long 0x0
MD n=Mem ra=0x00000038 d=0x396B0001	#	addi r11,r11,1
MD n=Mem ra=0x0000003c d=0x7FFA02A6	#	mfspr r31,SRR0
MD n=Mem ra=0x00000040 d=0x3BFF0004	#	addi  r31,r31,4
MD n=Mem ra=0x00000044 d=0x7FFA03A6	#	mtspr SRR0,r31
MD n=Mem ra=0x00000048 d=0x4C000064	#	rfi
MD n=Mem ra=0x0000004c d=0x00000000	#	.long 0x0
# </GEN>

TD n=MpuCam set=0 way=1 LB=0x1000 UB=0x1fff SR=1 SW=1 UR=1 UW=1 V=1
TD n=MpuCam set=0 way=2 LB=0x2000 UB=0x2fff SR=0 SW=0 UR=0 UW=0 V=1

MD n=Mem ra=0x1000 d=10
MD n=Mem ra=0x1004 d=10
MD n=Mem ra=0x1008 d=0
MD n=Mem ra=0x2004 d=20
MD n=Mem ra=0x2008 d=30

TRACE

I ea=0x0 id=1
T n=MpuCam t=instr set=0 way=0 ea=0x0 ra=0x0  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x0 ra=0x0 d=0x80201000
INSTR op=0x80201000					asm="lwz r1,4096(r0)"
D n=Mem t=read ea=0x1000 nb=4
T n=MpuCam t=load set=0 way=1 ea=0x1000 ra=0x1000  LB=0x1000 SR=0x1 SW=0x1 SX=0x0 UB=0x1fff UR=0x1 UW=0x1 UX=0x0 V=0x1
M n=Mem t=read ea=0x1000 ra=0x1000 d=0x0000000a
R n=GPR i=1 d=0x0000000a

I ea=0x4 id=2
T n=MpuCam t=instr set=0 way=0 ea=0x4 ra=0x4  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x4 ra=0x4 d=0x38210005
INSTR op=0x38210005					asm="addi r1,r1,5"
R n=GPR i=1 d=0x0000000f

I ea=0x8 id=3
T n=MpuCam t=instr set=0 way=0 ea=0x8 ra=0x8  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x8 ra=0x8 d=0x90201004
INSTR op=0x90201004					asm="stw r1,4100(r0)"
D n=Mem t=write ea=0x1004 nb=4
T n=MpuCam t=store set=0 way=1 ea=0x1004 ra=0x1004  LB=0x1000 SR=0x1 SW=0x1 SX=0x0 UB=0x1fff UR=0x1 UW=0x1 UX=0x0 V=0x1
M n=Mem t=write ea=0x1004 ra=0x1004 d=0x0000000f

I ea=0xc id=4
T n=MpuCam t=instr set=0 way=0 ea=0xc ra=0xc  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0xc ra=0xc d=0x90201008
INSTR op=0x90201008					asm="stw r1,4104(r0)"
D n=Mem t=write ea=0x1008 nb=4
T n=MpuCam t=store set=0 way=1 ea=0x1008 ra=0x1008  LB=0x1000 SR=0x1 SW=0x1 SX=0x0 UB=0x1fff UR=0x1 UW=0x1 UX=0x0 V=0x1
M n=Mem t=write ea=0x1008 ra=0x1008 d=0x0000000f

I ea=0x10 id=5
T n=MpuCam t=instr set=0 way=0 ea=0x10 ra=0x10  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x10 ra=0x10 d=0x80403000
INSTR op=0x80403000					asm="lwz r2,12288(r0)"
D n=Mem t=read ea=0x3000 nb=4
E n=DTlb
A l=1 m="In addr-check."
A l=1 m="DTLB on load."
R n=DEAR d=0x00003000
R n=SRR0 d=0x00000010
R n=SRR1 d=0x00000000
R n=MSR d=0x00000000

I ea=0x38 id=6
T n=MpuCam t=instr set=0 way=0 ea=0x38 ra=0x38  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x38 ra=0x38 d=0x396b0001
INSTR op=0x396b0001					asm="addi r11,r11,1"
R n=GPR i=11 d=0x00000001

I ea=0x3c id=7
T n=MpuCam t=instr set=0 way=0 ea=0x3c ra=0x3c  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x3c ra=0x3c d=0x7ffa02a6
INSTR op=0x7ffa02a6					asm="mfspr r31,SRR0"
R n=GPR i=31 d=0x00000010

I ea=0x40 id=8
T n=MpuCam t=instr set=0 way=0 ea=0x40 ra=0x40  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x40 ra=0x40 d=0x3bff0004
INSTR op=0x3bff0004					asm="addi r31,r31,4"
R n=GPR i=31 d=0x00000014

I ea=0x44 id=9
T n=MpuCam t=instr set=0 way=0 ea=0x44 ra=0x44  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x44 ra=0x44 d=0x7ffa03a6
INSTR op=0x7ffa03a6					asm="mtspr SRR0,r31"
R n=SRR0 d=0x00000014

I ea=0x48 id=10
T n=MpuCam t=instr set=0 way=0 ea=0x48 ra=0x48  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x48 ra=0x48 d=0x4c000064
INSTR op=0x4c000064					asm="rfi r0,r0,r0"
R n=MSR d=0x00000000

I ea=0x14 id=11
T n=MpuCam t=instr set=0 way=0 ea=0x14 ra=0x14  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x14 ra=0x14 d=0x90402004
INSTR op=0x90402004					asm="stw r2,8196(r0)"
D n=Mem t=write ea=0x2004 nb=4
T n=MpuCam t=store set=0 way=2 ea=0x2004 ra=0x2004  LB=0x2000 SR=0x0 SW=0x0 SX=0x0 UB=0x2fff UR=0x0 UW=0x0 UX=0x0 V=0x1
E n=ProtectionFault
R n=SRR0 d=0x00000014
R n=SRR1 d=0x00000000
R n=MSR d=0x00000000

I ea=0x20 id=12
T n=MpuCam t=instr set=0 way=0 ea=0x20 ra=0x20  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x20 ra=0x20 d=0x394a0001
INSTR op=0x394a0001					asm="addi r10,r10,1"
R n=GPR i=10 d=0x00000001

I ea=0x24 id=13
T n=MpuCam t=instr set=0 way=0 ea=0x24 ra=0x24  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x24 ra=0x24 d=0x7ffa02a6
INSTR op=0x7ffa02a6					asm="mfspr r31,SRR0"
R n=GPR i=31 d=0x00000014

I ea=0x28 id=14
T n=MpuCam t=instr set=0 way=0 ea=0x28 ra=0x28  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x28 ra=0x28 d=0x3bff0004
INSTR op=0x3bff0004					asm="addi r31,r31,4"
R n=GPR i=31 d=0x00000018

I ea=0x2c id=15
T n=MpuCam t=instr set=0 way=0 ea=0x2c ra=0x2c  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x2c ra=0x2c d=0x7ffa03a6
INSTR op=0x7ffa03a6					asm="mtspr SRR0,r31"
R n=SRR0 d=0x00000018

I ea=0x30 id=16
T n=MpuCam t=instr set=0 way=0 ea=0x30 ra=0x30  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x30 ra=0x30 d=0x4c000064
INSTR op=0x4c000064					asm="rfi r0,r0,r0"
R n=MSR d=0x00000000

I ea=0x18 id=17
T n=MpuCam t=instr set=0 way=0 ea=0x18 ra=0x18  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x18 ra=0x18 d=0x80402008
INSTR op=0x80402008					asm="lwz r2,8200(r0)"
D n=Mem t=read ea=0x2008 nb=4
T n=MpuCam t=load set=0 way=2 ea=0x2008 ra=0x2008  LB=0x2000 SR=0x0 SW=0x0 SX=0x0 UB=0x2fff UR=0x0 UW=0x0 UX=0x0 V=0x1
E n=ProtectionFault
R n=SRR0 d=0x00000018
R n=SRR1 d=0x00000000
R n=MSR d=0x00000000

I ea=0x20 id=18
T n=MpuCam t=instr set=0 way=0 ea=0x20 ra=0x20  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x20 ra=0x20 d=0x394a0001
INSTR op=0x394a0001					asm="addi r10,r10,1"
R n=GPR i=10 d=0x00000002

I ea=0x24 id=19
T n=MpuCam t=instr set=0 way=0 ea=0x24 ra=0x24  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x24 ra=0x24 d=0x7ffa02a6
INSTR op=0x7ffa02a6					asm="mfspr r31,SRR0"
R n=GPR i=31 d=0x00000018

I ea=0x28 id=20
T n=MpuCam t=instr set=0 way=0 ea=0x28 ra=0x28  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x28 ra=0x28 d=0x3bff0004
INSTR op=0x3bff0004					asm="addi r31,r31,4"
R n=GPR i=31 d=0x0000001c

I ea=0x2c id=21
T n=MpuCam t=instr set=0 way=0 ea=0x2c ra=0x2c  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x2c ra=0x2c d=0x7ffa03a6
INSTR op=0x7ffa03a6					asm="mtspr SRR0,r31"
R n=SRR0 d=0x0000001c

I ea=0x30 id=22
T n=MpuCam t=instr set=0 way=0 ea=0x30 ra=0x30  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x30 ra=0x30 d=0x4c000064
INSTR op=0x4c000064					asm="rfi r0,r0,r0"
R n=MSR d=0x00000000

I ea=0x1c id=23
T n=MpuCam t=instr set=0 way=0 ea=0x1c ra=0x1c  LB=0x0 SR=0x1 SW=0x1 SX=0x1 UB=0xfff UR=0x1 UW=0x1 UX=0x1 V=0x1
M n=Mem t=ifetch ea=0x1c ra=0x1c d=0x00000000
INSTR op=0x00000000					asm="halt "

RESULTS

MD n=Mem ra=0x1000 d=10
MD n=Mem ra=0x1004 d=15
MD n=Mem ra=0x1008 d=15
MD n=Mem ra=0x2004 d=20
MD n=Mem ra=0x2008 d=30

RD n=GPR i=1  d=15
RD n=GPR i=2  d=0
RD n=GPR i=10 d=2
RD n=GPR i=11 d=1
