#
# A test for branch prediction aliasing.
#   The loop trains the branch predictor so that ea=0x8 has a taken prediction.
#   This later causes a wrong prediction in the exception handler (mfspr) and
#   the program exits abnormally.  A safe-mode model is able to recover from
#   the mistaken prediction.
#
= asm

loop:
      add    r2,r2,r1
      subic. r3,r3,1
      bne    loop
      lwz    r1,0x1000(0)
      add    r2,r2,r1

= /asm

# <GEN>
MD n=Mem ra=0x00010000 d=0x7C420A14	# add r2,r2,r1
MD n=Mem ra=0x00010004 d=0x3463FFFF	# subic. r3,r3,1
MD n=Mem ra=0x00010008 d=0x4082FFF8	# bne loop
MD n=Mem ra=0x0001000C d=0x80201000	# lwz r1,0x1000(0)
MD n=Mem ra=0x00010010 d=0x7C420A14	# add r2,r2,r1

# Protection-fault handler.
MD n=Mem ra=0x000A0004 d=0x3BFF0001	# addi r31,r31,1
MD n=Mem ra=0x000A0008 d=0x7FDA02A6	# mfspr r30,SRR0
MD n=Mem ra=0x000A000C d=0x3BDE0004	# addi r30,r30,4
MD n=Mem ra=0x000A0010 d=0x7FDA03A6	# mtspr SRR0,r30
MD n=Mem ra=0x000A0014 d=0x4C000064	# rfi
# </GEN>

CORE n=:P
RD n=NIA     d=0
RD n=GPR i=1 d=30
RD n=GPR i=2 d=100
RD n=GPR i=3 d=10
RD n=MSR   d=0x00700000
RD n=IVOR7 d=0x00000004

# ea=0x0000 ra=0x10000
TD n=TlbCam set=0 way=0 V=1 TID=0 SIZE=1 TS=1 RPN=0x40 WIMG=0x1 EPN=0x0 SX=1 SR=1 SW=1 UX=1 UR=1 UW=1

# ea=0x0000 ra=0xA0000
TD n=TlbCam set=0 way=1 V=1 TID=0 SIZE=1 TS=0 RPN=0x280 WIMG=0x1 EPN=0x0 SX=1

# ea=0x1000 ra=0xA1000
TD n=TlbCam set=0 way=2 V=1 TID=0 SIZE=1 TS=1 RPN=0x284 WIMG=0x2 EPN=0x4 SX=0 SR=1 SW=0 UX=0 UR=0 UW=0 

TRACE

I ea=0x0 id=1
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x0 ra=0x10000 d=0x7c420a14
INSTR op=0x7c420a14					asm="add r2,r2,r1"
R n=GPR i=2 d=0x00000082

I ea=0x4 id=2
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x4 ra=0x10004 d=0x3463ffff
INSTR op=0x3463ffff					asm="addic. r3,r3,-1"
R n=GPR i=3 d=0x00000009
R n=CR d=0x40000000
R n=XER d=0x20000000

I ea=0x8 id=3
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x8 ra=0x10008 d=0x4082fff8
INSTR op=0x4082fff8					asm="bc 0x4,0x2,0x0000000000000000"

I ea=0x0 id=4
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x0 ra=0x10000 d=0x7c420a14
INSTR op=0x7c420a14					asm="add r2,r2,r1"
R n=GPR i=2 d=0x000000a0

I ea=0x4 id=5
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x4 ra=0x10004 d=0x3463ffff
INSTR op=0x3463ffff					asm="addic. r3,r3,-1"
R n=GPR i=3 d=0x00000008
R n=CR d=0x40000000
R n=XER d=0x20000000

I ea=0x8 id=6
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x8 ra=0x10008 d=0x4082fff8
INSTR op=0x4082fff8					asm="bc 0x4,0x2,0x0000000000000000"

I ea=0x0 id=7
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x0 ra=0x10000 d=0x7c420a14
INSTR op=0x7c420a14					asm="add r2,r2,r1"
R n=GPR i=2 d=0x000000be

I ea=0x4 id=8
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x4 ra=0x10004 d=0x3463ffff
INSTR op=0x3463ffff					asm="addic. r3,r3,-1"
R n=GPR i=3 d=0x00000007
R n=CR d=0x40000000
R n=XER d=0x20000000

I ea=0x8 id=9
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x8 ra=0x10008 d=0x4082fff8
INSTR op=0x4082fff8					asm="bc 0x4,0x2,0x0000000000000000"

I ea=0x0 id=10
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x0 ra=0x10000 d=0x7c420a14
INSTR op=0x7c420a14					asm="add r2,r2,r1"
R n=GPR i=2 d=0x000000dc

I ea=0x4 id=11
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x4 ra=0x10004 d=0x3463ffff
INSTR op=0x3463ffff					asm="addic. r3,r3,-1"
R n=GPR i=3 d=0x00000006
R n=CR d=0x40000000
R n=XER d=0x20000000

I ea=0x8 id=12
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x8 ra=0x10008 d=0x4082fff8
INSTR op=0x4082fff8					asm="bc 0x4,0x2,0x0000000000000000"

I ea=0x0 id=13
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x0 ra=0x10000 d=0x7c420a14
INSTR op=0x7c420a14					asm="add r2,r2,r1"
R n=GPR i=2 d=0x000000fa

I ea=0x4 id=14
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x4 ra=0x10004 d=0x3463ffff
INSTR op=0x3463ffff					asm="addic. r3,r3,-1"
R n=GPR i=3 d=0x00000005
R n=CR d=0x40000000
R n=XER d=0x20000000

I ea=0x8 id=15
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x8 ra=0x10008 d=0x4082fff8
INSTR op=0x4082fff8					asm="bc 0x4,0x2,0x0000000000000000"

I ea=0x0 id=16
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x0 ra=0x10000 d=0x7c420a14
INSTR op=0x7c420a14					asm="add r2,r2,r1"
R n=GPR i=2 d=0x00000118

I ea=0x4 id=17
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x4 ra=0x10004 d=0x3463ffff
INSTR op=0x3463ffff					asm="addic. r3,r3,-1"
R n=GPR i=3 d=0x00000004
R n=CR d=0x40000000
R n=XER d=0x20000000

I ea=0x8 id=18
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x8 ra=0x10008 d=0x4082fff8
INSTR op=0x4082fff8					asm="bc 0x4,0x2,0x0000000000000000"

I ea=0x0 id=19
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x0 ra=0x10000 d=0x7c420a14
INSTR op=0x7c420a14					asm="add r2,r2,r1"
R n=GPR i=2 d=0x00000136

I ea=0x4 id=20
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x4 ra=0x10004 d=0x3463ffff
INSTR op=0x3463ffff					asm="addic. r3,r3,-1"
R n=GPR i=3 d=0x00000003
R n=CR d=0x40000000
R n=XER d=0x20000000

I ea=0x8 id=21
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x8 ra=0x10008 d=0x4082fff8
INSTR op=0x4082fff8					asm="bc 0x4,0x2,0x0000000000000000"

I ea=0x0 id=22
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x0 ra=0x10000 d=0x7c420a14
INSTR op=0x7c420a14					asm="add r2,r2,r1"
R n=GPR i=2 d=0x00000154

I ea=0x4 id=23
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x4 ra=0x10004 d=0x3463ffff
INSTR op=0x3463ffff					asm="addic. r3,r3,-1"
R n=GPR i=3 d=0x00000002
R n=CR d=0x40000000
R n=XER d=0x20000000

I ea=0x8 id=24
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x8 ra=0x10008 d=0x4082fff8
INSTR op=0x4082fff8					asm="bc 0x4,0x2,0x0000000000000000"

I ea=0x0 id=25
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x0 ra=0x10000 d=0x7c420a14
INSTR op=0x7c420a14					asm="add r2,r2,r1"
R n=GPR i=2 d=0x00000172

I ea=0x4 id=26
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x4 ra=0x10004 d=0x3463ffff
INSTR op=0x3463ffff					asm="addic. r3,r3,-1"
R n=GPR i=3 d=0x00000001
R n=CR d=0x40000000
R n=XER d=0x20000000

I ea=0x8 id=27
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x8 ra=0x10008 d=0x4082fff8
INSTR op=0x4082fff8					asm="bc 0x4,0x2,0x0000000000000000"

I ea=0x0 id=28
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x0 ra=0x10000 d=0x7c420a14
INSTR op=0x7c420a14					asm="add r2,r2,r1"
R n=GPR i=2 d=0x00000190

I ea=0x4 id=29
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x4 ra=0x10004 d=0x3463ffff
INSTR op=0x3463ffff					asm="addic. r3,r3,-1"
R n=GPR i=3 d=0x00000000
R n=CR d=0x20000000
R n=XER d=0x20000000

I ea=0x8 id=30
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x8 ra=0x10008 d=0x4082fff8
INSTR op=0x4082fff8					asm="bc 0x4,0x2,0x0000000000000000"

I ea=0xc id=31
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0xc ra=0x1000c d=0x80201000
INSTR op=0x80201000					asm="lwz r1,4096(r0)"
D n=Mem t=read ea=0x1000 nb=4
E n=ProtectionFault
R n=SRR0 d=0x0000000c
R n=SRR1 d=0x00700000
R n=MSR d=0x00000000

I ea=0x4 id=32
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x280 SIZE=0x1 SR=0x0 SW=0x0 SX=0x1 TID=0x0 TS=0x0 UR=0x0 UW=0x0 UX=0x0 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x4 ra=0xa0004 d=0x3bff0001
INSTR op=0x3bff0001					asm="addi r31,r31,1"
R n=GPR i=31 d=0x00000001

I ea=0x8 id=33
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x280 SIZE=0x1 SR=0x0 SW=0x0 SX=0x1 TID=0x0 TS=0x0 UR=0x0 UW=0x0 UX=0x0 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x8 ra=0xa0008 d=0x7fda02a6
INSTR op=0x7fda02a6					asm="mfspr r30,SRR0"
R n=GPR i=30 d=0x0000000c

I ea=0xc id=34
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x280 SIZE=0x1 SR=0x0 SW=0x0 SX=0x1 TID=0x0 TS=0x0 UR=0x0 UW=0x0 UX=0x0 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0xc ra=0xa000c d=0x3bde0004
INSTR op=0x3bde0004					asm="addi r30,r30,4"
R n=GPR i=30 d=0x00000010

I ea=0x10 id=35
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x280 SIZE=0x1 SR=0x0 SW=0x0 SX=0x1 TID=0x0 TS=0x0 UR=0x0 UW=0x0 UX=0x0 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x10 ra=0xa0010 d=0x7fda03a6
INSTR op=0x7fda03a6					asm="mtspr r30,SRR0"
R n=SRR0 d=0x00000010

I ea=0x14 id=36
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x280 SIZE=0x1 SR=0x0 SW=0x0 SX=0x1 TID=0x0 TS=0x0 UR=0x0 UW=0x0 UX=0x0 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x14 ra=0xa0014 d=0x4c000064
INSTR op=0x4c000064					asm="rfi r0,r0,r0"
R n=MSR d=0x00700000

I ea=0x10 id=37
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x10 ra=0x10010 d=0x7c420a14
INSTR op=0x7c420a14					asm="add r2,r2,r1"
R n=GPR i=2 d=0x000001ae

I ea=0x14 id=38
T n=TlbCam t=instr  E=0x0 EPN=0x0 RPN=0x40 SIZE=0x1 SR=0x1 SW=0x1 SX=0x1 TID=0x0 TS=0x1 UR=0x1 UW=0x1 UX=0x1 V=0x1 WIMG=0x1
M n=Mem t=ifetch ea=0x14 ra=0x10014 d=0x00000000
INSTR op=0x00					asm="halt "

RESULTS

RD n=GPR i=1 d=30
RD n=GPR i=2 d=430
RD n=GPR i=3 d=0
